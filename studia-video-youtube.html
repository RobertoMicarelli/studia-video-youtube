<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Studia i tuoi Video Preferiti</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Outfit:wght@600;700;800&display=swap" rel="stylesheet">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        'sans': ['Inter', 'system-ui', 'sans-serif'],
                        'display': ['Outfit', 'system-ui', 'sans-serif'],
                    },
                    colors: {
                        primary: {
                            50: '#f0f9ff',
                            100: '#e0f2fe',
                            500: '#0ea5e9',
                            600: '#0284c7',
                            700: '#0369a1',
                        },
                        accent: {
                            500: '#8b5cf6',
                            600: '#7c3aed',
                        }
                    }
                }
            }
        }
    </script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        
        .glass-card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.3);
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
        }

        .gradient-text {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            transition: all 0.3s ease;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px -5px rgba(102, 126, 234, 0.6);
        }

        .btn-primary:active {
            transform: translateY(0);
        }

        .step-item {
            transition: all 0.3s ease;
        }

        .step-item.active {
            transform: scale(1.05);
        }

        @keyframes pulse-slow {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .animate-pulse-slow {
            animation: pulse-slow 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }

        .progress-bar {
            transition: width 0.5s ease;
        }

        input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .step-icon {
            transition: all 0.3s ease;
        }

        .step-icon.completed {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
        }

        .step-icon.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .slide-in {
            animation: slideIn 0.5s ease-out;
        }

        .result-card {
            background: linear-gradient(135deg, rgba(16, 185, 129, 0.1) 0%, rgba(5, 150, 105, 0.1) 100%);
            border-left: 4px solid #10b981;
        }

        @keyframes float {
            0%, 100% { transform: translateY(0px); }
            50% { transform: translateY(-10px); }
        }

        .float-animation {
            animation: float 3s ease-in-out infinite;
        }
    </style>
</head>
<body class="p-4 md:p-8">
    <div class="max-w-5xl mx-auto">
        <!-- Header -->
        <div class="text-center mb-8 slide-in">
            <div class="text-6xl mb-4 float-animation">üìö</div>
            <h1 class="text-4xl md:text-5xl lg:text-6xl font-display font-bold text-white mb-3">
                Studia i tuoi Video Preferiti
            </h1>
            <p class="text-lg md:text-xl text-white/90 font-light">
                Trasforma qualsiasi video YouTube in dispense di studio professionali
            </p>
        </div>

        <!-- Main Card -->
        <div class="glass-card rounded-3xl p-6 md:p-10 mb-6 slide-in" style="animation-delay: 0.1s;">
            <!-- Input Section -->
            <div class="mb-8">
                <label for="youtubeUrl" class="block text-sm font-semibold text-gray-700 mb-3">
                    üé¨ Incolla il link del video YouTube
                </label>
                <input 
                    type="text" 
                    id="youtubeUrl" 
                    placeholder="https://www.youtube.com/watch?v=..."
                    class="w-full px-5 py-4 border-2 border-gray-200 rounded-xl text-base focus:border-primary-500 transition-all"
                />
                <p class="text-sm text-gray-500 mt-2">
                    üí° Esempio: https://www.youtube.com/watch?v=dQw4w9WgXcQ
                </p>
                <p class="text-xs text-gray-400 mt-1">
                    ‚è±Ô∏è Limite massimo: 4 ore (240 minuti) di video
                </p>
                
                <!-- Google Authentication Status -->
                <div id="authStatus" class="mt-4 p-3 rounded-lg" style="display: none;">
                    <div class="flex items-center justify-between">
                        <div class="flex items-center gap-2">
                            <span id="authIcon">üîê</span>
                            <span id="authText" class="text-sm font-medium"></span>
                        </div>
                        <button 
                            id="authButton"
                            onclick="authenticateGoogle()"
                            class="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg text-sm font-medium transition-colors"
                        >
                            Accedi con Google
                        </button>
                    </div>
                </div>
            </div>

            <!-- Category Selection -->
            <div id="categorySelection" class="mb-6 p-6 bg-white border border-gray-200 rounded-xl shadow-sm">
                <h3 class="text-lg font-bold text-gray-800 mb-4">üìÅ Seleziona la cartella di destinazione</h3>
                <div class="mb-4">
                    <label for="categorySelect" class="block text-sm font-medium text-gray-700 mb-2">
                        Cartella:
                    </label>
                    <select 
                        id="categorySelect" 
                        class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent text-gray-800 font-medium"
                    >
                        <option value="STUDIO AI">STUDIO AI</option>
                        <option value="FORMAZIONE" selected>FORMAZIONE</option>
                        <option value="INTERVISTE">INTERVISTE</option>
                        <option value="APPLICAZIONI">APPLICAZIONI</option>
                        <option value="FILOSOFIA">FILOSOFIA</option>
                        <option value="COACHING">COACHING</option>
                        <option value="VARIE">VARIE</option>
                    </select>
                </div>
                <div class="mb-6">
                    <label for="categoryCustom" class="block text-sm font-medium text-gray-700 mb-2">
                        Oppure inserisci un nome personalizzato (tutto in MAIUSCOLE):
                    </label>
                    <input 
                        type="text" 
                        id="categoryCustom" 
                        placeholder="es. TECNOLOGIA"
                        class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent text-gray-800 uppercase"
                        oninput="this.value = this.value.toUpperCase()"
                    />
                </div>
                <button 
                    onclick="startProcessing()"
                    class="w-full btn-primary text-white px-6 py-4 rounded-xl font-semibold text-base shadow-lg hover:shadow-xl transition-all flex items-center justify-center gap-2"
                >
                    <span>‚ú®</span>
                    <span>Genera Dispensa</span>
                </button>
            </div>

            <!-- Progress Section -->
            <div id="progressSection" class="hidden mb-8">
                <div class="mb-4">
                    <div class="flex justify-between items-center mb-2">
                        <span class="text-sm font-semibold text-gray-700">Progresso</span>
                        <span id="progressPercent" class="text-sm font-bold gradient-text">0%</span>
                    </div>
                    <div class="w-full bg-gray-200 rounded-full h-3 overflow-hidden">
                        <div id="progressBar" class="progress-bar h-full rounded-full" style="width: 0%; background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);"></div>
                    </div>
                </div>

                <!-- Steps -->
                <div class="grid grid-cols-2 md:grid-cols-4 gap-3 mt-6">
                    <div class="step-item text-center" data-step="1">
                        <div class="step-icon w-12 h-12 rounded-full bg-gray-200 mx-auto mb-2 flex items-center justify-center text-xl">
                            üì•
                        </div>
                        <p class="text-xs font-medium text-gray-600">Estrazione</p>
                    </div>
                    <div class="step-item text-center" data-step="2">
                        <div class="step-icon w-12 h-12 rounded-full bg-gray-200 mx-auto mb-2 flex items-center justify-center text-xl">
                            ü§ñ
                        </div>
                        <p class="text-xs font-medium text-gray-600">Elaborazione AI</p>
                    </div>
                    <div class="step-item text-center" data-step="3">
                        <div class="step-icon w-12 h-12 rounded-full bg-gray-200 mx-auto mb-2 flex items-center justify-center text-xl">
                            üíæ
                        </div>
                        <p class="text-xs font-medium text-gray-600">Salvataggio</p>
                    </div>
                    <div class="step-item text-center" data-step="4">
                        <div class="step-icon w-12 h-12 rounded-full bg-gray-200 mx-auto mb-2 flex items-center justify-center text-xl">
                            üìß
                        </div>
                        <p class="text-xs font-medium text-gray-600">Notifica</p>
                    </div>
                </div>

                <!-- Status Message -->
                <div id="statusMessage" class="mt-6 p-4 bg-blue-50 border border-blue-200 rounded-xl">
                    <p class="text-sm text-blue-800 text-center font-medium">
                        In attesa di elaborazione...
                    </p>
                </div>
            </div>

            <!-- Result Section -->
            <div id="resultSection" class="hidden">
                <div class="result-card p-6 rounded-xl mb-4">
                    <div class="flex items-start gap-4">
                        <div class="text-4xl">‚úÖ</div>
                        <div class="flex-1">
                            <h3 class="text-xl font-bold text-gray-800 mb-2">Dispensa Creata con Successo!</h3>
                            <p class="text-gray-600 mb-4" id="resultDescription">
                                La tua dispensa √® stata generata e salvata in Google Drive.
                            </p>
                            <div class="space-y-2">
                                <div class="flex items-center gap-2 text-sm">
                                    <span class="font-semibold text-gray-700">üìÑ Documento:</span>
                                    <a id="docLink" href="#" target="_blank" class="text-blue-600 hover:text-blue-700 underline">Apri in Google Drive</a>
                                </div>
                                <div class="flex items-center gap-2 text-sm">
                                    <span class="font-semibold text-gray-700">üìÅ Cartella:</span>
                                    <span id="folderName" class="text-gray-600">-</span>
                                </div>
                                <div class="flex items-center gap-2 text-sm">
                                    <span class="font-semibold text-gray-700">üìß Email:</span>
                                    <span class="text-green-600 font-medium">Inviata a roberto.micarelli@gmail.com</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <button 
                    onclick="resetApp()"
                    class="w-full bg-gray-100 hover:bg-gray-200 text-gray-700 px-6 py-3 rounded-xl font-semibold transition-all"
                >
                    ‚ûï Elabora un Altro Video
                </button>
            </div>
        </div>

        <!-- Info Cards -->
        <div class="grid md:grid-cols-3 gap-4 slide-in" style="animation-delay: 0.2s;">
            <div class="bg-white/90 backdrop-blur-sm rounded-2xl p-6 shadow-lg hover:shadow-xl transition-shadow">
                <div class="text-3xl mb-3">üéØ</div>
                <h3 class="font-bold text-gray-800 mb-2">Formattazione Professionale</h3>
                <p class="text-sm text-gray-600">
                    Trascrizioni organizzate con titoli, abstract, parole chiave e sezioni tematiche.
                </p>
            </div>
            <div class="bg-white/90 backdrop-blur-sm rounded-2xl p-6 shadow-lg hover:shadow-xl transition-shadow">
                <div class="text-3xl mb-3">üóÇÔ∏è</div>
                <h3 class="font-bold text-gray-800 mb-2">Organizzazione Automatica</h3>
                <p class="text-sm text-gray-600">
                    I documenti vengono catalogati automaticamente per argomento nel tuo Drive.
                </p>
            </div>
            <div class="bg-white/90 backdrop-blur-sm rounded-2xl p-6 shadow-lg hover:shadow-xl transition-shadow">
                <div class="text-3xl mb-3">üìä</div>
                <h3 class="font-bold text-gray-800 mb-2">Tracciamento Completo</h3>
                <p class="text-sm text-gray-600">
                    Email di notifica e registro automatico in Google Sheets di tutti i contenuti generati.
                </p>
            </div>
        </div>

        <!-- How it Works Section -->
        <div class="mt-8 glass-card rounded-2xl p-6 md:p-8 slide-in" style="animation-delay: 0.3s;">
            <h2 class="text-2xl font-bold text-gray-800 mb-6 text-center">Come Funziona</h2>
            <div class="grid md:grid-cols-2 gap-6">
                <div class="flex gap-4">
                    <div class="flex-shrink-0 w-10 h-10 rounded-full bg-gradient-to-br from-purple-500 to-pink-500 flex items-center justify-center text-white font-bold">1</div>
                    <div>
                        <h4 class="font-semibold text-gray-800 mb-1">Inserisci il Link</h4>
                        <p class="text-sm text-gray-600">Copia l'URL del video YouTube che vuoi studiare</p>
                    </div>
                </div>
                <div class="flex gap-4">
                    <div class="flex-shrink-0 w-10 h-10 rounded-full bg-gradient-to-br from-blue-500 to-cyan-500 flex items-center justify-center text-white font-bold">2</div>
                    <div>
                        <h4 class="font-semibold text-gray-800 mb-1">Estrazione Automatica</h4>
                        <p class="text-sm text-gray-600">L'AI estrae la trascrizione e analizza il contenuto</p>
                    </div>
                </div>
                <div class="flex gap-4">
                    <div class="flex-shrink-0 w-10 h-10 rounded-full bg-gradient-to-br from-green-500 to-emerald-500 flex items-center justify-center text-white font-bold">3</div>
                    <div>
                        <h4 class="font-semibold text-gray-800 mb-1">Dispensa Strutturata</h4>
                        <p class="text-sm text-gray-600">Viene generata una dispensa didattica ben formattata</p>
                    </div>
                </div>
                <div class="flex gap-4">
                    <div class="flex-shrink-0 w-10 h-10 rounded-full bg-gradient-to-br from-orange-500 to-red-500 flex items-center justify-center text-white font-bold">4</div>
                    <div>
                        <h4 class="font-semibold text-gray-800 mb-1">Salvataggio su Drive</h4>
                        <p class="text-sm text-gray-600">Il documento viene salvato e catalogato automaticamente</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Footer Note -->
        <div class="mt-8 text-center text-white/80 text-sm">
            <p>üîê I tuoi dati sono al sicuro. L'app accede solo alle cartelle autorizzate nel tuo Google Drive.</p>
            <p class="mt-2 text-xs text-white/60">Questa √® una demo. Per la versione completa √® necessario configurare le API di Google Drive, YouTube e OpenAI.</p>
        </div>
    </div>

    <script>
        // Configurazione
        const CONFIG = {
            driveFolder: '1nhFM1-c2lG9xKPdMjQfLPqU6jtofrRRH',
            email: 'roberto.micarelli@gmail.com',
            categories: ['INTERVISTE', 'STUDIO AI', 'APPLICAZIONI', 'TECNOLOGIA', 'FORMAZIONE']
        };

        // Configurazione - Le API keys sono gestite dal backend (Vercel Functions)
        // Non esporre mai API keys nel codice frontend!
        let googleAccessToken = null;

        // Recupera token da URL se presente (dopo OAuth callback)
        const urlParams = new URLSearchParams(window.location.search);
        if (urlParams.get('token')) {
            googleAccessToken = urlParams.get('token');
            const expiresIn = parseInt(urlParams.get('expires_in') || '3600'); // Default 1 ora
            const refreshToken = urlParams.get('refresh_token');
            
            // Calcola timestamp di scadenza
            const expiresAt = Date.now() + (expiresIn * 1000);
            
            // Salva in localStorage
            localStorage.setItem('googleAccessToken', googleAccessToken);
            localStorage.setItem('googleTokenExpiresAt', expiresAt.toString());
            if (refreshToken) {
                localStorage.setItem('googleRefreshToken', refreshToken);
            }
            
            // Rimuovi token dall'URL per sicurezza
            window.history.replaceState({}, document.title, window.location.pathname);
        } else {
            // Prova a recuperare da localStorage
            googleAccessToken = localStorage.getItem('googleAccessToken');
            const expiresAt = localStorage.getItem('googleTokenExpiresAt');
            
            // Verifica se il token √® scaduto e prova a refresharlo
            if (googleAccessToken && expiresAt) {
                const now = Date.now();
                const expirationTime = parseInt(expiresAt);
                
                // Se il token √® scaduto o sta per scadere (entro 5 minuti), prova a refresharlo
                if (now >= (expirationTime - 5 * 60 * 1000)) {
                    const refreshToken = localStorage.getItem('googleRefreshToken');
                    if (refreshToken) {
                        // Prova a refreshare il token in modo sincrono (senza await perch√© siamo in fase di inizializzazione)
                        fetch('/api/auth?action=refresh', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({ refresh_token: refreshToken })
                        })
                        .then(refreshResponse => {
                            if (refreshResponse.ok) {
                                return refreshResponse.json();
                            }
                            throw new Error('Refresh failed');
                        })
                        .then(tokenData => {
                            googleAccessToken = tokenData.access_token;
                            const newExpiresAt = Date.now() + (tokenData.expires_in * 1000);
                            
                            localStorage.setItem('googleAccessToken', googleAccessToken);
                            localStorage.setItem('googleTokenExpiresAt', newExpiresAt.toString());
                            
                            console.log('Token Google refreshato all\'avvio');
                            updateAuthStatus();
                        })
                        .catch(error => {
                            console.warn('Impossibile refreshare il token Google all\'avvio:', error);
                            googleAccessToken = null;
                            localStorage.removeItem('googleAccessToken');
                            localStorage.removeItem('googleTokenExpiresAt');
                            localStorage.removeItem('googleRefreshToken');
                            updateAuthStatus();
                        });
                    } else {
                        // Nessun refresh token disponibile, rimuovi access token
                        console.warn('Token Google scaduto e nessun refresh token disponibile');
                        googleAccessToken = null;
                        localStorage.removeItem('googleAccessToken');
                        localStorage.removeItem('googleTokenExpiresAt');
                    }
                }
            }
        }

        // Prompt per OpenAI - PROMPT GPT'S PER TRASCRIZIONE VIDEO EFFICACE
        const PROMPT_TEMPLATE = `Tu sei un/una redattore/redattrice didattico/a professionale.

Il tuo compito √® trasformare la trascrizione di un video YouTube in una dispensa didattica strutturata, chiara, DETTAGLIATA e COMPLETA, pronta per l'uso in contesti formativi (HR, azienda, universit√†, formazione continua).

IMPORTANTE: La dispensa deve essere MOLTO DETTAGLIATA e APPROFONDITA. Non sintetizzare eccessivamente: sviluppa ogni concetto in modo completo, fornisci esempi, spiegazioni approfondite e collegamenti tra le idee. La dispensa deve essere lunga almeno 3-4 volte la lunghezza della trascrizione originale (dopo la pulizia delle ripetizioni).

INPUT ATTESO:

La trascrizione estratta dal link video dato in input tramite le API Youtube Video

Trascrizione del video (anche molto lunga, con ripetizioni, interiezioni, commenti di chat, ecc.)

Se qualche metadato (titolo, autore, URL) manca, non chiedere integrazioni: fai il meglio possibile con ci√≤ che hai (es. segnala "Non disponibile" o lascia il campo vuoto in modo elegante).

OBIETTIVO

A partire dalla trascrizione:

Ripulisci il contenuto (niente "ehm", ripetizioni, saluti iniziali/finali inutili, problemi tecnici, ecc.).

Riorganizza il materiale in forma di dispensa didattica coerente, logica, scorrevole e MOLTO DETTAGLIATA.

Mantieni TUTTI i concetti importanti, specialmente quelli teorici, tecnici e gli esempi che aiutano a capire.

SVILUPPA ogni concetto in modo completo e approfondito: non limitarti a menzionare, ma spiega, approfondisci, fornisci contesto, esempi e dettagli.

La dispensa deve essere lunga e completa: sviluppa ogni sezione in modo esaustivo, fornisci spiegazioni dettagliate, aggiungi esempi concreti, espandi i concetti chiave.

Non inventare nuovi contenuti che nel video non ci sono; puoi solo:

riformulare in modo pi√π chiaro e dettagliato

espandere e approfondire i concetti gi√† presenti

collegare meglio le idee gi√† presenti con transizioni e spiegazioni

fornire contesto e dettagli aggiuntivi per chiarire i concetti

STRUTTURA OBBLIGATORIA DELL'OUTPUT

Devi SEMPRE restituire il risultato in questo formato, in italiano:

METADATI DEL VIDEO

Scrivi in apertura:

Autore: {{AUTORE}}

Titolo: {{TITOLO}}

URL YouTube: {{VIDEO_URL}}

Temi Trattati: {{TEMI_TRATTATI}}

Data di elaborazione: ${new Date().toLocaleDateString('it-IT')}

IMPORTANTE: Usa ESATTAMENTE i valori forniti sopra per Autore e Titolo. Non modificare o riformulare questi metadati, inseriscili cos√¨ come sono.

ABSTRACT

Un paragrafo di 3‚Äì4 righe che sintetizzi:

l'argomento principale del video

gli obiettivi formativi

i punti chiave che verranno trattati

il target di riferimento (es. HR, manager, formatori, studenti, ecc.)

CORPO DELLA DISPENSA

IMPORTANTE: Il CORPO DELLA DISPENSA deve essere MOLTO DETTAGLIATO e APPROFONDITO. Sviluppa ogni concetto in modo completo, non limitarti a sintetizzare. La dispensa deve essere lunga e completa.

Usa titoli e sottotitoli gerarchici in Markdown:

# per le macro-sezioni

## per sezioni interne

### per eventuali sotto-paragrafi

Suddividi il contenuto in sezioni tematiche chiare (es. definizioni, modelli teorici, esempi pratici, implicazioni per HR, domande dal pubblico‚Ä¶).

Sviluppa ogni sezione in modo approfondito:
- Fornisci definizioni complete e dettagliate
- Spiega i concetti in modo esaustivo
- Aggiungi esempi concreti e applicazioni pratiche
- Collega le idee tra loro con transizioni logiche
- Espandi i concetti chiave con approfondimenti

Mantieni paragrafi di lunghezza media (4‚Äì6 righe) per permettere uno sviluppo completo dei concetti.

Evidenzia in grassetto:

concetti chiave

definizioni importanti

frasi-sintesi davvero cruciali.

Usa elenchi puntati per:

elencare definizioni

citare vantaggi/svantaggi

schematizzare modelli o tassonomie

Inserisci box informativi per le definizioni pi√π importanti o per concetti cardine del video, nello stile:

> **BOX ‚Äì Titolo del concetto**

> Spiegazione sintetica (1‚Äì3 frasi) del concetto.

Riorganizza i contenuti in ordine logico-didattico, non necessariamente cronologico:

prima le definizioni di base (sviluppate in modo completo e dettagliato)

poi le distinzioni concettuali (con spiegazioni approfondite)

poi esempi/applicazioni (con descrizioni dettagliate e casi concreti)

infine implicazioni pratiche (es. per HR, manager, formatori, ecc.) - sviluppa ogni implicazione in modo completo

Sviluppa ogni sezione in modo approfondito: non limitarti a elencare, ma spiega, approfondisci, fornisci contesto e dettagli.

Elimina:

ripetizioni

interruzioni tecniche

riferimenti di "regia" (audio che non va, chat tecnica, ecc.)

saluti e convenevoli non rilevanti.

Mantieni invece:

domande del pubblico che introducono temi sostanziali

esempi chiarificatori

passaggi in cui l'autore esplicita modelli, tassonomie, distinzioni teoriche.

SEZIONE FINALE

Chiudi sempre con tre sottosezioni:

## Punti chiave da ricordare

- [3‚Äì5 bullet sintetici con i messaggi principali]

## Approfondimenti suggeriti

- [Eventuali libri, articoli, autori, modelli citati nel video]

- [Se non ci sono approfondimenti citati, scrivi qualcosa di neutro tipo: "Nel video non sono stati indicati approfondimenti specifici, ma si suggerisce di esplorare la letteratura su ‚Ä¶"]

## Applicazioni pratiche

- [Come usare nella pratica i concetti esposti (es. cosa pu√≤ fare un/una HR, un manager, un team leader, uno studente, ecc.)]

TONO DI VOCE

Professionale ma accessibile

Chiaro, diretto, non accademico, ma concettualmente rigoroso

Orientato all'apprendimento e alla consultazione rapida

Mantieni la terminologia tecnica quando √® utile (es. potere coercitivo, potere economico, leadership, consenso, ecc.), spiegandola con frasi semplici quando necessario.

REGOLE E VINCOLI IMPORTANTI

Non chiedere mai all'utente di "aspettare", "tenere duro" o simili: produci sempre la dispensa completa nella stessa risposta.

Non fare domande di chiarimento all'utente: usa al meglio il materiale che hai.

Non aggiungere note personali del tipo "secondo me l'autore‚Ä¶": mantieni un taglio neutro e descrittivo, riportando il pensiero dell'autore del video.

Non cambiare lingua: lavora sempre in italiano, anche se nella trascrizione compaiono parole di altre lingue.

Se nella trascrizione c'√® confusione, sovrapposizione o audio disturbato, fai una ricostruzione prudente e lineare, evitando di inventare contenuti.

TRASCRIZIONE:

{{TRANSCRIPT}}`;

        let currentVideoData = {};

        function validateYouTubeUrl(url) {
            const regex = /^(https?:\/\/)?(www\.)?(youtube\.com\/watch\?v=|youtu\.be\/)([a-zA-Z0-9_-]{11})/;
            const match = url.match(regex);
            return match ? match[4] : null;
        }

        function updateProgress(percent, step, message) {
            document.getElementById('progressBar').style.width = percent + '%';
            document.getElementById('progressPercent').textContent = percent + '%';
            document.getElementById('statusMessage').innerHTML = `
                <p class="text-sm text-blue-800 text-center font-medium">${message}</p>
            `;

            // Update step icons
            document.querySelectorAll('.step-item').forEach((item, index) => {
                const icon = item.querySelector('.step-icon');
                icon.classList.remove('active', 'completed');
                
                if (index + 1 < step) {
                    icon.classList.add('completed');
                } else if (index + 1 === step) {
                    icon.classList.add('active');
                    item.classList.add('active');
                } else {
                    item.classList.remove('active');
                }
            });
        }

        async function getYouTubeTranscript(videoId) {
            try {
                const response = await fetch('/api/youtube', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ videoId })
                });

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.error || 'Errore estrazione trascrizione');
                }

                const data = await response.json();
                return {
                    title: data.title,
                    author: data.author,
                    transcript: data.transcript,
                    tags: data.tags || [],
                    temiTrattati: data.temiTrattati || '',
                    description: data.description || ''
                };
            } catch (error) {
                console.error('Errore YouTube API:', error);
                // Fallback a modalit√† demo in caso di errore
                return new Promise((resolve) => {
                    setTimeout(() => {
                        resolve({
                            title: "Machine Learning e AI - Introduzione Completa",
                            author: "Tech Education Channel",
                            transcript: "Trascrizione non disponibile. Modalit√† demo attiva."
                        });
                    }, 1000);
                });
            }
        }

        async function processWithOpenAI(transcript, videoTitle, videoUrl, author, temiTrattati, category) {
            // Validazione lunghezza trascrizione (limite 4 ore)
            // Stima approssimativa: ~250 token per minuto, 4 ore = ~60.000 token
            const estimatedTokens = Math.ceil(transcript.length / 4);
            const maxTokensFor4Hours = 60000;
            
            if (estimatedTokens > maxTokensFor4Hours) {
                throw new Error('Video troppo lungo. Il limite massimo √® di 4 ore (240 minuti). Per favore, usa un video pi√π corto.');
            }

            // Prepara i metadati per il prompt
            const temiFinali = temiTrattati || '#tema1 #tema2 #tema3 #tema4 #tema5';
            const autoreFinale = author || 'Non disponibile';
            const titoloFinale = videoTitle || 'Non disponibile';
            
            console.log('=== METADATI PER PROMPT ===');
            console.log('Autore:', autoreFinale);
            console.log('Titolo:', titoloFinale);
            console.log('URL:', videoUrl);
            console.log('Temi:', temiFinali);
            console.log('===========================');
            
            const prompt = PROMPT_TEMPLATE
                .replace('{{VIDEO_URL}}', videoUrl)
                .replace('{{TEMI_TRATTATI}}', temiFinali)
                .replace('{{AUTORE}}', autoreFinale)
                .replace('{{TITOLO}}', titoloFinale)
                .replace('{{TRANSCRIPT}}', transcript);
            
            // Debug: verifica che i placeholder siano stati sostituiti
            if (prompt.includes('{{AUTORE}}') || prompt.includes('{{TITOLO}}')) {
                console.warn('‚ö†Ô∏è ATTENZIONE: Alcuni placeholder non sono stati sostituiti!');
                console.log('Prompt preview (primi 500 caratteri):', prompt.substring(0, 500));
            }

            try {
                const response = await fetch('/api/openai', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        transcript,
                        videoTitle,
                        videoUrl,
                        author,
                        prompt
                    })
                });

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.error || 'Errore elaborazione OpenAI');
                }

                const data = await response.json();
                return data.dispensa;
            } catch (error) {
                console.error('Errore chiamata OpenAI:', error);
                // Rilancia l'errore per gestirlo nel flusso principale
                throw error;
            }
        }

        function generateMockDispensa(title, url, author, transcript) {
            const today = new Date().toLocaleDateString('it-IT');
            return `**Autore:** ${author}
**Titolo:** ${title}
**URL YouTube:** ${url}
**Temi Trattati:** #machinelearning #AI #intelligenzaartificiale #deeplearning #tecnologia
**Data di elaborazione:** ${today}

ABSTRACT

Questo video introduce i concetti fondamentali del Machine Learning e dell'intelligenza artificiale moderna. L'obiettivo √® fornire una panoramica completa delle diverse tipologie di apprendimento automatico, delle loro caratteristiche distintive e delle applicazioni pratiche nel mondo reale. Ideale per studenti, professionisti e chiunque voglia comprendere le basi dell'AI contemporanea.

## 1. INTRODUZIONE AL MACHINE LEARNING

Il **Machine Learning** rappresenta una delle rivoluzioni tecnologiche pi√π significative del nostro tempo. Si tratta di una branca dell'intelligenza artificiale che permette ai sistemi informatici di apprendere dai dati senza essere esplicitamente programmati per ogni singola situazione.

### 1.1 Definizione e Principi Fondamentali

Il Machine Learning si basa sulla capacit√† dei sistemi di:
* **Analizzare** grandi quantit√† di dati
* **Identificare** pattern e correlazioni nascoste
* **Migliorare** le proprie prestazioni nel tempo
* **Generalizzare** l'apprendimento a nuove situazioni

A differenza della programmazione tradizionale, dove ogni regola deve essere codificata manualmente, il ML permette ai sistemi di scoprire autonomamente regole e relazioni nei dati.

## 2. LE TRE TIPOLOGIE PRINCIPALI DI MACHINE LEARNING

### 2.1 Supervised Learning (Apprendimento Supervisionato)

Nel **supervised learning**, l'algoritmo apprende da un dataset etichettato, dove ogni esempio √® associato alla risposta corretta. √à come avere un insegnante che fornisce feedback continuo durante il processo di apprendimento.

**Caratteristiche principali:**
* Dataset con etichette predefinite (labels)
* Feedback diretto su ogni previsione
* Obiettivo: prevedere output per nuovi input

**Esempi di applicazioni:**
* Classificazione di email (spam/non spam)
* Riconoscimento di immagini e oggetti
* Previsione di prezzi immobiliari
* Diagnosi mediche assistite

**Problemi tipici:**
* **Classificazione**: Assegnare categorie discrete (es. gatto/cane)
* **Regressione**: Prevedere valori continui (es. prezzo di una casa)

### 2.2 Unsupervised Learning (Apprendimento Non Supervisionato)

L'**unsupervised learning** lavora con dati non etichettati. L'algoritmo deve scoprire autonomamente la struttura nascosta e i pattern nei dati, senza alcuna guida esterna.

**Caratteristiche principali:**
* Nessuna etichetta predefinita
* Ricerca autonoma di strutture nei dati
* Obiettivo: scoprire relazioni e raggruppamenti

**Esempi di applicazioni:**
* Segmentazione di clienti per marketing
* Compressione di dati (riduzione dimensionalit√†)
* Rilevamento di anomalie in sistemi di sicurezza
* Analisi esplorativa dei dati

**Tecniche comuni:**
* **Clustering**: Raggruppare dati simili (K-means, DBSCAN)
* **Dimensionality Reduction**: Semplificare dati complessi (PCA, t-SNE)
* **Association Rules**: Scoprire relazioni tra elementi

### 2.3 Reinforcement Learning (Apprendimento per Rinforzo)

Il **reinforcement learning** si basa su un sistema di premi e punizioni. Un agente impara a prendere decisioni attraverso l'interazione continua con un ambiente, ricevendo feedback sotto forma di ricompense.

**Caratteristiche principali:**
* Sistema di reward/penalty
* Apprendimento per tentativi ed errori
* Obiettivo: massimizzare la ricompensa cumulativa

**Esempi di applicazioni:**
* Giochi strategici (AlphaGo, scacchi, videogiochi)
* Robotica e controllo di sistemi autonomi
* Ottimizzazione di processi industriali
* Trading algoritmico

**Componenti chiave:**
* **Agente**: Entit√† che prende decisioni
* **Ambiente**: Contesto in cui opera l'agente
* **Azioni**: Scelte possibili dell'agente
* **Ricompense**: Feedback dall'ambiente

## 3. CONCETTI FONDAMENTALI

### 3.1 Features (Caratteristiche)

Le **features** sono le caratteristiche misurabili dei dati che l'algoritmo utilizza per fare previsioni. La selezione e l'ingegnerizzazione delle features sono cruciali per il successo di un modello.

### 3.2 Training e Testing

Il processo di sviluppo di un modello ML si divide in due fasi:

* **Training**: L'algoritmo apprende dai dati di esempio
* **Testing**: Il modello viene valutato su dati mai visti prima

Questa separazione √® essenziale per verificare la capacit√† di generalizzazione del modello ed evitare l'**overfitting** (memorizzazione dei dati invece che apprendimento di pattern generali).

### 3.3 Algoritmi Popolari

Tra gli algoritmi pi√π utilizzati troviamo:

* **Reti Neurali**: Ispirate al cervello umano, eccellenti per pattern complessi
* **Alberi Decisionali**: Facili da interpretare, utili per decisioni gerarchiche
* **Support Vector Machines (SVM)**: Efficaci per classificazione binaria
* **Random Forest**: Ensemble di alberi per previsioni robuste
* **K-Nearest Neighbors (KNN)**: Basato sulla similarit√† tra esempi

## 4. DEEP LEARNING: LA RIVOLUZIONE DELLE RETI NEURALI PROFONDE

Il **deep learning** rappresenta un sottoinsieme del ML basato su reti neurali con molti livelli (layer). Questa tecnologia ha permesso progressi straordinari negli ultimi anni.

### Applicazioni del Deep Learning:

* **Computer Vision**: Riconoscimento facciale, analisi di immagini mediche
* **Natural Language Processing**: Traduzione automatica, chatbot, analisi del sentiment
* **Generative AI**: Creazione di immagini, testi e musica
* **Speech Recognition**: Assistenti vocali come Alexa, Siri, Google Assistant

## 5. APPLICAZIONI PRATICHE NEL MONDO REALE

Il Machine Learning ha trasformato numerosi settori industriali:

### 5.1 Entertainment e Media
* **Sistemi di raccomandazione**: Netflix, Spotify, YouTube
* **Personalizzazione dei contenuti**
* **Moderazione automatica**

### 5.2 Sanit√†
* **Diagnosi assistita**: Analisi di radiografie e risonanze
* **Scoperta di farmaci**: Identificazione di nuove molecole
* **Medicina personalizzata**

### 5.3 Finanza
* **Rilevamento frodi**: Identificazione di transazioni sospette
* **Trading algoritmico**: Decisioni di investimento automatizzate
* **Credit scoring**: Valutazione del rischio creditizio

### 5.4 Trasporti
* **Veicoli autonomi**: Auto a guida automatica
* **Ottimizzazione delle rotte**
* **Manutenzione predittiva**

### 5.5 Retail e E-commerce
* **Personalizzazione dell'esperienza utente**
* **Gestione dell'inventario**
* **Pricing dinamico**

## 6. STRUMENTI E FRAMEWORK PER INIZIARE

Per chi vuole avvicinarsi al Machine Learning, esistono eccellenti strumenti:

### Framework e Librerie:
* **Scikit-learn**: Ideale per iniziare, API semplice
* **TensorFlow**: Framework completo di Google
* **PyTorch**: Molto popolare in ricerca, flessibile
* **Keras**: API ad alto livello per deep learning

### Piattaforme di Apprendimento:
* **Kaggle**: Dataset, competizioni e community
* **Google Colab**: Notebook gratuiti con GPU
* **Jupyter Notebooks**: Ambiente interattivo per sperimentazione

## 7. SFIDE ETICHE E CONSIDERAZIONI

Lo sviluppo responsabile dell'AI richiede attenzione a:

* **Bias nei dati**: Evitare discriminazioni algoritmiche
* **Privacy**: Protezione dei dati personali
* **Trasparenza**: Spiegabilit√† delle decisioni
* **Accountability**: Responsabilit√† nelle decisioni automatizzate
* **Impatto sociale**: Effetti su lavoro ed economia

---

### PUNTI CHIAVE DA RICORDARE:

* Il Machine Learning permette ai computer di apprendere dai dati senza programmazione esplicita
* Esistono tre paradigmi principali: supervised, unsupervised e reinforcement learning
* Il deep learning ha rivoluzionato il campo con reti neurali profonde
* Le applicazioni spaziano dalla sanit√† alla finanza, dall'intrattenimento ai trasporti
* Framework come TensorFlow e PyTorch rendono l'ML accessibile a tutti
* √à fondamentale considerare le implicazioni etiche dello sviluppo dell'AI

### APPROFONDIMENTI SUGGERITI:

* Studiare matematica alla base del ML (algebra lineare, calcolo, statistica)
* Esplorare dataset reali su Kaggle per progetti pratici
* Seguire corsi strutturati (Coursera, edX, Fast.ai)
* Leggere paper di ricerca su arXiv per scoprire le ultime innovazioni
* Partecipare a comunit√† online (Reddit r/MachineLearning, forum specializzati)

### APPLICAZIONI PRATICHE:

* Iniziare con progetti semplici: classificazione di iris, previsione prezzi case
* Sperimentare con dataset pubblici (MNIST, CIFAR-10, ImageNet)
* Costruire portfolio di progetti su GitHub
* Partecipare a competizioni Kaggle per testare le proprie competenze
* Contribuire a progetti open source di ML`;
        }

        function selectCategory(themes) {
            const themesLower = themes.toLowerCase();
            
            if (themesLower.includes('ai') || themesLower.includes('machine learning') || themesLower.includes('intelligenza') || themesLower.includes('deeplearning')) {
                return 'STUDIO AI';
            } else if (themesLower.includes('intervista') || themesLower.includes('interview')) {
                return 'INTERVISTE';
            } else if (themesLower.includes('applicazione') || themesLower.includes('app') || themesLower.includes('software')) {
                return 'APPLICAZIONI';
            } else if (themesLower.includes('tecnologia') || themesLower.includes('tech')) {
                return 'TECNOLOGIA';
            } else {
                return 'FORMAZIONE';
            }
        }

        // Funzione helper per refreshare il token se necessario
        async function refreshTokenIfNeeded() {
            const expiresAt = localStorage.getItem('googleTokenExpiresAt');
            if (!expiresAt) return false;
            
            const now = Date.now();
            const expirationTime = parseInt(expiresAt);
            
            // Se il token √® scaduto o sta per scadere (entro 5 minuti), refreshalo
            if (now >= (expirationTime - 5 * 60 * 1000)) {
                const refreshToken = localStorage.getItem('googleRefreshToken');
                if (!refreshToken) return false;
                
                try {
                    const refreshResponse = await fetch('/api/auth?action=refresh', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ refresh_token: refreshToken })
                    });
                    
                    if (refreshResponse.ok) {
                        const tokenData = await refreshResponse.json();
                        googleAccessToken = tokenData.access_token;
                        const newExpiresAt = Date.now() + (tokenData.expires_in * 1000);
                        
                        localStorage.setItem('googleAccessToken', googleAccessToken);
                        localStorage.setItem('googleTokenExpiresAt', newExpiresAt.toString());
                        
                        console.log('Token Google refreshato automaticamente');
                        return true;
                    }
                } catch (error) {
                    console.error('Errore durante refresh token:', error);
                }
            }
            return false;
        }

        // Funzione helper per refreshare il token se necessario
        async function refreshTokenIfNeeded() {
            const expiresAt = localStorage.getItem('googleTokenExpiresAt');
            if (!expiresAt || !googleAccessToken) return false;
            
            const now = Date.now();
            const expirationTime = parseInt(expiresAt);
            
            // Se il token √® scaduto o sta per scadere (entro 5 minuti), refreshalo
            if (now >= (expirationTime - 5 * 60 * 1000)) {
                const refreshToken = localStorage.getItem('googleRefreshToken');
                if (!refreshToken) return false;
                
                try {
                    const refreshResponse = await fetch('/api/auth?action=refresh', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ refresh_token: refreshToken })
                    });
                    
                    if (refreshResponse.ok) {
                        const tokenData = await refreshResponse.json();
                        googleAccessToken = tokenData.access_token;
                        const newExpiresAt = Date.now() + (tokenData.expires_in * 1000);
                        
                        localStorage.setItem('googleAccessToken', googleAccessToken);
                        localStorage.setItem('googleTokenExpiresAt', newExpiresAt.toString());
                        
                        console.log('Token Google refreshato automaticamente');
                        return true;
                    }
                } catch (error) {
                    console.error('Errore durante refresh token:', error);
                }
            }
            return false;
        }

        async function saveToGoogleDrive(content, title, category) {
            if (!googleAccessToken) {
                throw new Error('Autenticazione Google richiesta. Esegui il login.');
            }

            // Prova a refreshare il token se necessario
            await refreshTokenIfNeeded();

            try {
                const response = await fetch('/api/drive', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        content,
                        title,
                        category,
                        accessToken: googleAccessToken
                    })
                });

                if (!response.ok) {
                    const error = await response.json();
                    const errorMessage = error.error || 'Errore salvataggio Google Drive';
                    
                    // Rileva se il token √® scaduto o non valido
                    if (response.status === 401 || 
                        errorMessage.includes('invalid authentication credentials') ||
                        errorMessage.includes('Invalid Credentials') ||
                        errorMessage.includes('unauthorized')) {
                        // Prova a refreshare il token una volta
                        const refreshed = await refreshTokenIfNeeded();
                        
                        if (refreshed) {
                            // Riprova la richiesta con il nuovo token
                            const retryResponse = await fetch('/api/drive', {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/json'
                                },
                                body: JSON.stringify({
                                    content,
                                    title,
                                    category,
                                    accessToken: googleAccessToken
                                })
                            });
                            
                            if (retryResponse.ok) {
                                const data = await retryResponse.json();
                                return data;
                            }
                        }
                        
                        // Refresh fallito o retry fallito, richiedi nuovo login
                        console.warn('Token Google scaduto o non valido, richiesta nuova autenticazione');
                        googleAccessToken = null;
                        localStorage.removeItem('googleAccessToken');
                        localStorage.removeItem('googleTokenExpiresAt');
                        localStorage.removeItem('googleRefreshToken');
                        updateAuthStatus();
                        throw new Error('La sessione Google √® scaduta. Per favore, esegui nuovamente il login con Google.');
                    }
                    
                    throw new Error(errorMessage);
                }

                const data = await response.json();
                return {
                    success: true,
                    docUrl: data.docUrl,
                    docId: data.docId,
                    category: data.category
                };
            } catch (error) {
                console.error('Errore Google Drive API:', error);
                throw error;
            }
        }

        async function sendEmail(docUrl, videoUrl, abstract, fileName) {
            if (!googleAccessToken) {
                console.warn('Token Google non disponibile, email non inviata');
                return { success: false };
            }

            // Prova a refreshare il token se necessario
            await refreshTokenIfNeeded();

            try {
                const response = await fetch('/api/gmail', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        docUrl,
                        videoUrl,
                        abstract,
                        fileName,
                        accessToken: googleAccessToken
                    })
                });

                if (!response.ok) {
                    const error = await response.json();
                    const errorMessage = error.error || 'Errore invio email';
                    
                    // Rileva se il token √® scaduto o non valido
                    if (response.status === 401 || 
                        errorMessage.includes('invalid authentication credentials') ||
                        errorMessage.includes('Invalid Credentials') ||
                        errorMessage.includes('unauthorized')) {
                        // Token scaduto o non valido
                        console.warn('Token Google scaduto durante invio email');
                        googleAccessToken = null;
                        localStorage.removeItem('googleAccessToken');
                        localStorage.removeItem('googleTokenExpiresAt');
                        localStorage.removeItem('googleRefreshToken');
                        updateAuthStatus();
                        return { success: false, error: 'La sessione Google √® scaduta. Per favore, esegui nuovamente il login.' };
                    }
                    
                    console.error('Errore invio email:', error);
                    return { success: false, error: errorMessage };
                }

                const data = await response.json();
                return { success: true, messageId: data.messageId };
            } catch (error) {
                console.error('Errore Gmail API:', error);
                return { success: false, error: error.message };
            }
        }

        async function updateGoogleSheet(data) {
            if (!googleAccessToken) {
                console.warn('Token Google non disponibile, sheet non aggiornato');
                return { success: false };
            }

            // Prova a refreshare il token se necessario
            await refreshTokenIfNeeded();

            try {
                const response = await fetch('/api/sheets', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        ...data,
                        accessToken: googleAccessToken
                    })
                });

                if (!response.ok) {
                    const error = await response.json();
                    const errorMessage = error.error || 'Errore aggiornamento sheet';
                    
                    // Rileva se il token √® scaduto o non valido
                    if (response.status === 401 || 
                        errorMessage.includes('invalid authentication credentials') ||
                        errorMessage.includes('Invalid Credentials') ||
                        errorMessage.includes('unauthorized')) {
                        // Token scaduto o non valido
                        console.warn('Token Google scaduto durante aggiornamento sheet');
                        googleAccessToken = null;
                        localStorage.removeItem('googleAccessToken');
                        localStorage.removeItem('googleTokenExpiresAt');
                        localStorage.removeItem('googleRefreshToken');
                        updateAuthStatus();
                        return { success: false, error: 'La sessione Google √® scaduta. Per favore, esegui nuovamente il login.' };
                    }
                    
                    console.error('Errore aggiornamento sheet:', error);
                    return { success: false, error: errorMessage };
                }

                const result = await response.json();
                return { success: true, updatedRange: result.updatedRange };
            } catch (error) {
                console.error('Errore Google Sheets API:', error);
                return { success: false, error: error.message };
            }
        }

        // Funzione per aggiornare lo stato dell'autenticazione
        function updateAuthStatus() {
            const authStatus = document.getElementById('authStatus');
            const authIcon = document.getElementById('authIcon');
            const authText = document.getElementById('authText');
            const authButton = document.getElementById('authButton');
            
            if (googleAccessToken) {
                authStatus.style.display = 'block';
                authStatus.className = 'mt-4 p-3 rounded-lg bg-green-50 border border-green-200';
                authIcon.textContent = '‚úÖ';
                authText.textContent = 'Autenticato con Google';
                authButton.textContent = 'Disconnetti';
                authButton.onclick = () => {
                    googleAccessToken = null;
                    localStorage.removeItem('googleAccessToken');
                    localStorage.removeItem('googleTokenExpiresAt');
                    localStorage.removeItem('googleRefreshToken');
                    updateAuthStatus();
                };
                authButton.className = 'px-4 py-2 bg-red-600 hover:bg-red-700 text-white rounded-lg text-sm font-medium transition-colors';
            } else {
                authStatus.style.display = 'block';
                authStatus.className = 'mt-4 p-3 rounded-lg bg-yellow-50 border border-yellow-200';
                authIcon.textContent = '‚ö†Ô∏è';
                authText.textContent = 'Autenticazione Google richiesta per salvare su Drive';
                authButton.textContent = 'Accedi con Google';
                authButton.onclick = authenticateGoogle;
                authButton.className = 'px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg text-sm font-medium transition-colors';
            }
        }

        // Funzione per autenticazione Google OAuth
        async function authenticateGoogle() {
            try {
                const response = await fetch('/api/auth?action=auth-url');
                if (!response.ok) {
                    throw new Error('Errore generazione URL autenticazione');
                }
                const data = await response.json();
                window.location.href = data.authUrl;
            } catch (error) {
                console.error('Errore autenticazione:', error);
                alert('Errore durante l\'autenticazione. Verifica che le variabili d\'ambiente GOOGLE_CLIENT_ID e GOOGLE_REDIRECT_URI siano configurate in Vercel.');
            }
        }

        // Inizializza stato autenticazione all'avvio
        updateAuthStatus();

        async function startProcessing() {
            const urlInput = document.getElementById('youtubeUrl');
            const url = urlInput.value.trim();
            
            if (!url) {
                alert('‚ö†Ô∏è Per favore, inserisci un URL YouTube valido');
                return;
            }

            const videoId = validateYouTubeUrl(url);
            if (!videoId) {
                alert('‚ö†Ô∏è URL YouTube non valido. Assicurati che sia nel formato corretto.\n\nEsempio: https://www.youtube.com/watch?v=dQw4w9WgXcQ');
                return;
            }

            // Ottieni la categoria selezionata
            const selectedCategory = document.getElementById('categorySelect').value;
            const customCategory = document.getElementById('categoryCustom').value.trim();
            const category = customCategory || selectedCategory;
            
            if (!category) {
                alert('‚ö†Ô∏è Per favore, seleziona una cartella o inserisci un nome personalizzato');
                return;
            }

            // Nascondi sezione categoria e mostra sezione progresso
            document.getElementById('categorySelection').classList.add('hidden');
            document.getElementById('progressSection').classList.remove('hidden');
            document.getElementById('resultSection').classList.add('hidden');

            try {
                // Step 1: Estrazione trascrizione
                updateProgress(10, 1, 'üì• Connessione a YouTube...');
                await new Promise(resolve => setTimeout(resolve, 500));
                
                updateProgress(20, 1, 'üì• Estrazione trascrizione dal video...');
                const videoData = await getYouTubeTranscript(videoId);
                currentVideoData = { ...videoData, url };

                updateProgress(30, 1, '‚úÖ Trascrizione estratta con successo!');
                await new Promise(resolve => setTimeout(resolve, 800));

                // Step 2: Elaborazione con OpenAI
                updateProgress(35, 2, 'ü§ñ Inizializzazione intelligenza artificiale...');
                await new Promise(resolve => setTimeout(resolve, 500));
                
                updateProgress(40, 2, 'ü§ñ Elaborazione con OpenAI GPT...');
                const dispensa = await processWithOpenAI(
                    videoData.transcript, 
                    videoData.title, 
                    url, 
                    videoData.author,
                    videoData.temiTrattati,
                    category
                );
                currentVideoData.dispensa = dispensa;

                updateProgress(65, 2, '‚úÖ Dispensa generata con successo!');
                await new Promise(resolve => setTimeout(resolve, 800));

                // Step 3: Salvataggio su Google Drive con categoria gi√† selezionata
                updateProgress(70, 3, 'üíæ Creazione documento Google Docs...');
                await new Promise(resolve => setTimeout(resolve, 500));
                
                updateProgress(75, 3, `üíæ Salvataggio nella cartella "${category}"...`);
                
                // Verifica autenticazione prima di salvare
                if (!googleAccessToken) {
                    throw new Error('Autenticazione Google richiesta. Clicca su "Accedi con Google" prima di generare la dispensa.');
                }
                
                const driveResult = await saveToGoogleDrive(dispensa, videoData.title, category);
                currentVideoData.driveResult = driveResult;
                
                updateProgress(85, 3, '‚úÖ Documento salvato su Google Drive!');
                await new Promise(resolve => setTimeout(resolve, 800));

                // Step 4: Invio email e aggiornamento sheet
                updateProgress(88, 4, 'üìß Preparazione email di notifica...');
                
                // Estrai abstract
                let abstract = 'Dispensa didattica generata da video YouTube';
                
                console.log('=== DEBUG ESTRAZIONE ABSTRACT ===');
                console.log('Lunghezza dispensa:', dispensa.length);
                console.log('Preview dispensa (primi 1000 caratteri):', dispensa.substring(0, 1000));
                
                const patterns = [
                    /ABSTRACT\s*\n\n(.+?)(?=\n\nCORPO DELLA DISPENSA|$)/is,
                    /##\s*ABSTRACT\s*\n\n(.+?)(?=\n\n##\s*CORPO|$)/is,
                    /(?:##\s*)?2\.\s*ABSTRACT\s*\n\n(.+?)(?=\n\n(?:##\s*)?(?:3\.|CORPO)|$)/is,
                    /(?:##\s*)?ABSTRACT\s*\n\n(.+?)(?=\n\n(?:##\s*)?(?:CORPO|#)|$)/is,
                    /^ABSTRACT\s*\n\n(.+?)(?=\n\n(?:##\s*)?(?:CORPO|#)|$)/ims,
                    /ABSTRACT[:\s]*\n\n(.+?)(?=\n\n(?:##\s*)?(?:CORPO|METADATI|#)|$)/is
                ];
                
                for (let i = 0; i < patterns.length; i++) {
                    const pattern = patterns[i];
                    const match = dispensa.match(pattern);
                    
                    if (match && match[1]) {
                        let extractedAbstract = match[1]
                            .trim()
                            .replace(/\*\*/g, '')
                            .replace(/\*/g, '')
                            .replace(/#/g, '')
                            .replace(/^\s*[-*‚Ä¢]\s+/gm, '')
                            .replace(/\n+/g, ' ')
                            .replace(/\s+/g, ' ')
                            .trim();
                        
                        if (extractedAbstract.length > 50) {
                            abstract = extractedAbstract.substring(0, 1000);
                            break;
                        }
                    }
                }
                
                if (abstract === 'Dispensa didattica generata da video YouTube' || abstract.length < 50) {
                    const abstractIndex = dispensa.search(/(?:##\s*)?2\.\s*ABSTRACT|ABSTRACT/i);
                    const nextSectionIndex = dispensa.search(/(?:##\s*)?3\.|##\s*CORPO/i);
                    
                    if (abstractIndex !== -1 && nextSectionIndex !== -1 && nextSectionIndex > abstractIndex) {
                        let alternativeAbstract = dispensa.substring(abstractIndex, nextSectionIndex)
                            .replace(/(?:##\s*)?2\.\s*ABSTRACT|ABSTRACT/gi, '')
                            .trim()
                            .replace(/\*\*/g, '')
                            .replace(/\*/g, '')
                            .replace(/#/g, '')
                            .replace(/^\s*[-*‚Ä¢]\s+/gm, '')
                            .replace(/\n+/g, ' ')
                            .replace(/\s+/g, ' ')
                            .trim();
                        
                        if (alternativeAbstract.length > 50) {
                            abstract = alternativeAbstract.substring(0, 1000);
                        }
                    }
                }
                
                console.log('=== FINE DEBUG ESTRAZIONE ABSTRACT ===');
                
                await sendEmail(driveResult.docUrl, url, abstract, videoData.title);
                
                updateProgress(93, 4, '‚úÖ Email inviata!');
                await new Promise(resolve => setTimeout(resolve, 500));
                
                updateProgress(96, 4, 'üìä Aggiornamento registro Google Sheets...');
                
                await updateGoogleSheet({
                    timestamp: new Date().toISOString(),
                    title: videoData.title,
                    url: url,
                    docUrl: driveResult.docUrl,
                    category: category,
                    abstract: abstract
                });
                
                console.log('‚úÖ Dati inviati a Google Sheets');
                
                updateProgress(100, 4, '‚úÖ Processo completato!');
                await new Promise(resolve => setTimeout(resolve, 1000));
                
                // Mostra risultati
                showResults(videoData.title, driveResult.docUrl, category, abstract);

            } catch (error) {
                console.error('Errore durante l\'elaborazione:', error);
                const errorMessage = error.message || 'Errore durante l\'elaborazione. Riprova pi√π tardi.';
                
                // Reset progress bar
                updateProgress(0, 1, '');
                
                // Gestione errori specifici
                if (errorMessage.includes('Autenticazione Google') || errorMessage.includes('autenticazione')) {
                    document.getElementById('statusMessage').innerHTML = `
                        <div class="text-sm text-red-800 text-center p-4 bg-red-50 border border-red-200 rounded-lg">
                            <p class="font-bold mb-2">‚ùå Autenticazione Google Richiesta</p>
                            <p class="mb-3">Per salvare la dispensa su Google Drive, devi prima autenticarti con Google.</p>
                            <button 
                                onclick="authenticateGoogle()"
                                class="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg text-sm font-medium transition-colors"
                            >
                                üîê Accedi con Google
                            </button>
                            <p class="text-xs text-gray-600 mt-3">Dopo l'autenticazione, puoi rigenerare la dispensa.</p>
                        </div>
                    `;
                } else if (errorMessage.includes('troppo lungo') || errorMessage.includes('4 ore')) {
                    document.getElementById('statusMessage').innerHTML = `
                        <div class="text-sm text-red-800 text-center p-4 bg-red-50 border border-red-200 rounded-lg">
                            <p class="font-bold mb-2">‚ùå Video troppo lungo</p>
                            <p class="mb-2">Il limite massimo √® di <strong>4 ore (240 minuti)</strong>.</p>
                            <p class="text-xs text-gray-600">Per favore, usa un video pi√π corto o dividi il contenuto in pi√π parti.</p>
                        </div>
                    `;
                } else {
                    document.getElementById('statusMessage').innerHTML = `
                        <div class="text-sm text-red-800 text-center p-4 bg-red-50 border border-red-200 rounded-lg">
                            <p class="font-bold mb-2">‚ùå Errore durante l'elaborazione</p>
                            <p class="mb-2">${errorMessage}</p>
                            <p class="text-xs text-gray-600 mt-2">Controlla la console del browser (F12) per maggiori dettagli.</p>
                        </div>
                    `;
                }
            }
        }

        function showResults(title, docUrl, category, abstract) {
            document.getElementById('progressSection').classList.add('hidden');
            document.getElementById('resultSection').classList.remove('hidden');
            
            const shortAbstract = abstract.length > 200 ? abstract.substring(0, 200) + '...' : abstract;
            document.getElementById('resultDescription').textContent = shortAbstract;
            document.getElementById('docLink').href = docUrl;
            document.getElementById('docLink').textContent = title;
            document.getElementById('folderName').textContent = category;
        }

        function resetApp() {
            document.getElementById('youtubeUrl').value = '';
            document.getElementById('categoryCustom').value = '';
            document.getElementById('categorySelect').value = 'FORMAZIONE';
            document.getElementById('progressSection').classList.add('hidden');
            document.getElementById('resultSection').classList.add('hidden');
            document.getElementById('categorySelection').classList.remove('hidden');
            document.getElementById('progressBar').style.width = '0%';
            document.getElementById('progressPercent').textContent = '0%';
            
            // Reset step icons
            document.querySelectorAll('.step-item').forEach(item => {
                const icon = item.querySelector('.step-icon');
                icon.classList.remove('active', 'completed');
                item.classList.remove('active');
            });
            
            currentVideoData = {};
        }

        // Informazioni per sviluppatori
        console.log('%cüìö Studia i tuoi Video Preferiti - APP Demo', 'font-size: 20px; font-weight: bold; color: #667eea;');
        console.log('%c\nPer implementazione completa necessari:', 'font-size: 14px; font-weight: bold; color: #666;');
        console.log('‚úì Google Drive API per salvare documenti');
        console.log('‚úì YouTube Transcript API (backend) per estrarre trascrizioni');
        console.log('‚úì OpenAI API (GPT-4o-mini) per elaborazione AI');
        console.log('‚úì Gmail API o SMTP per invio email');
        console.log('‚úì Google Sheets API per tracciamento');
        console.log('\n%cQuesta demo simula tutte le chiamate API', 'font-size: 12px; color: #999;');
    </script>
</body>
</html>
